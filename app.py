import streamlit as st
import pandas as pd
import re
from io import BytesIO

# --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞‡∏™‡πÑ‡∏ï‡∏•‡πå ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏• v9.9.0", layout="wide")

def inject_custom_css():
    st.markdown("""
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        html, body, [class*="css"] { font-family: 'Sarabun', sans-serif; }
        .main-header { background: linear-gradient(90deg, #0d47a1, #1976d2); padding: 20px; border-radius: 15px; text-align: center; color: white; margin-bottom: 25px; }
        .room-section { background-color: #f8f9fa; border-left: 8px solid #1565c0; padding: 15px; margin: 20px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
    """, unsafe_allow_html=True)

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ (Name Scrubbing) ---
def normalize_name(text):
    """‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà (Match)"""
    if not text or pd.isna(text): return ""
    # 1. ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©) ‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    t = str(text).lower().replace(" ", "").replace("\xa0", "")
    # 2. ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
    prefixes = r'(‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢|‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á|‡∏ô‡∏≤‡∏¢|‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß|‡∏î\.‡∏ä\.|‡∏î\.‡∏ç\.|‡∏ô\.‡∏™\.|‡∏ô‡∏≤‡∏á|‡∏ä‡∏∑‡πà‡∏≠|‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•|:|Ôºö)'
    t = re.sub(prefixes, '', t)
    # 3. ‡∏•‡∏ö‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î
    t = re.sub(r'[\.\-\_\(\)]', '', t)
    return t

# --- 3. ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Master (‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á) ---
def process_master_files(files):
    all_students = []
    for f in files:
        try:
            df = pd.read_excel(f) if f.name.endswith(('.xlsx', '.xls')) else pd.read_csv(f, encoding='utf-8-sig')
            # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏∑‡πà‡∏≠
            c_sid = next((c for c in df.columns if "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" in str(c)), None)
            c_name = next((c for c in df.columns if any(k in str(c) for k in ["‡∏ä‡∏∑‡πà‡∏≠", "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"])), None)
            
            if c_name:
                # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
                room_info = f.name.replace('.xlsx', '').replace('.csv', '')
                
                for _, row in df.iterrows():
                    raw_name = str(row[c_name])
                    all_students.append({
                        'key': normalize_name(raw_name), # ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ü‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô Key
                        'display_name': raw_name.strip(),
                        'no': row[c_sid] if c_sid else "-",
                        'room': room_info
                    })
        except: continue
    
    # ‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡πÉ‡∏ô Master (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á)
    return pd.DataFrame(all_students).drop_duplicates(subset=['key'], keep='first')

# --- 4. ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô (Padlet) ---
def process_padlet_works(files):
    works = []
    for f in files:
        try:
            df = pd.read_excel(f) if f.name.endswith(('.xlsx', '.xls')) else pd.read_csv(f, encoding='utf-8-sig')
            for _, row in df.iterrows():
                # ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                content = " ".join(map(str, row.values))
                # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° 1.1 - 1.14
                act_match = re.search(r'1\.(\d{1,2})', content)
                if act_match:
                    works.append({
                        'clean_content': normalize_name(content),
                        'activity': f"1.{act_match.group(1)}"
                    })
        except: continue
    return works

# --- 5. Main Application ---
def main():
    inject_custom_css()
    st.markdown('<div class="main-header"><h1>üìã ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏π‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏• v9.9.0</h1><p>‡∏¢‡∏∂‡∏î‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</p></div>', unsafe_allow_html=True)

    col1, col2 = st.columns(2)
    master_files = col1.file_uploader("üìÇ 1. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)", accept_multiple_files=True)
    padlet_files = col2.file_uploader("üìÇ 2. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Padlet", accept_multiple_files=True)

    if master_files and padlet_files:
        # ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Master
        df_master = process_master_files(master_files)
        # ‡∏î‡∏∂‡∏á‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Padlet
        works = process_padlet_works(padlet_files)
        
        if df_master.empty:
            st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏ä‡∏∑‡πà‡∏≠' ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏£‡∏±‡∏ö")
            return

        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° 1.1 - 1.14 ‡∏£‡∏≠‡πÑ‡∏ß‡πâ
        activities = [f"1.{i}" for i in range(1, 15)]
        for act in activities:
            df_master[act] = 0

        # üöÄ ‡∏≠‡∏±‡∏•‡∏Å‡∏≠‡∏£‡∏¥‡∏ó‡∏∂‡∏°‡∏Å‡∏≤‡∏£ Match ‡∏á‡∏≤‡∏ô: ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ Padlet
        for work in works:
            # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡πà‡∏≤ Key ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏´‡∏ô ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ Padlet ‡∏ö‡πâ‡∏≤‡∏á
            mask = df_master['key'].apply(lambda k: k in work['clean_content'] if k else False)
            df_master.loc[mask, work['activity']] = 1

        # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á
        rooms = sorted(df_master['room'].unique())
        for room in rooms:
            with st.container():
                st.markdown(f'<div class="room-section"><h3>üè´ ‡∏´‡πâ‡∏≠‡∏á: {room}</h3></div>', unsafe_allow_html=True)
                room_data = df_master[df_master['room'] == room].copy()
                room_data['‡∏£‡∏ß‡∏°'] = room_data[activities].sum(axis=1)
                
                # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                display_cols = ['no', 'display_name'] + activities + ['‡∏£‡∏ß‡∏°']
                st.dataframe(
                    room_data[display_cols].rename(columns={'no': '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà', 'display_name': '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'}),
                    use_container_width=True, hide_index=True
                )
                
                # ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á
                buf = BytesIO()
                room_data[display_cols].to_excel(buf, index=False)
                st.download_button(f"üì• ‡πÇ‡∏´‡∏•‡∏î Excel {room}", buf.getvalue(), f"Report_{room}.xlsx")
    else:
        st.info("üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå Padlet ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö")

if __name__ == "__main__":
    main()
